import {createSlice, PayloadAction} from "@reduxjs/toolkit";
import {AppThunk} from "../store";
import {setLoading} from './commonReducer'
import {getStreamInfo, TwitchLiveInfo} from "../../infrastructure/twitch/twitchApi";
import {getStorageData} from "../../infrastructure/chromeStorage/chromeStorage";

interface Twitchtore {
    liveStreams: TwitchLiveInfo[]
}

const twitchSlice = createSlice({
    name: 'twitch',
    initialState: {
        liveStreams: []
    } as Twitchtore,
    reducers: {
        addStream: (state: Twitchtore, {payload}: PayloadAction<TwitchLiveInfo>) => {
            state.liveStreams.push(payload);
        },
        resetLiveStreams: (state: Twitchtore) => {
            state.liveStreams = []
        },
        sortByViewers: (state: Twitchtore) => {
            state.liveStreams.sort((a: TwitchLiveInfo, b: TwitchLiveInfo) => b.viewers - a.viewers);
        }
    }
});

const {addStream, resetLiveStreams, sortByViewers} = twitchSlice.actions;

export const getLiveStreams = (): AppThunk => async dispatch => {
    dispatch(resetLiveStreams());

    const streamNamesList: string[] = ['Ka1one', 'thenumber13_'];//await getStorageData("streamNamesList") || [];
    if(!streamNamesList.length) return;

    dispatch(setLoading());

    const results = [
        {"status":"fulfilled","value":{"_id":39641756428,"game":"FIFA 21","broadcast_platform":"live","community_id":"","community_ids":[],"viewers":16,"video_height":900,"average_fps":60,"delay":0,"created_at":"2020-10-11T11:39:16Z","is_playlist":false,"stream_type":"live","preview":{"small":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-80x45.jpg","medium":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-320x180.jpg","large":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-640x360.jpg","template":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-{width}x{height}.jpg"},"channel":{"mature":true,"status":"Cenas da Vida a um Domingo","broadcaster_language":"pt","broadcaster_software":"","display_name":"KA1ONE","game":"FIFA 21","language":"en","_id":31391096,"name":"ka1one","created_at":"2012-06-17T01:13:40.058127Z","updated_at":"2020-10-11T14:11:18.340383Z","partner":false,"logo":"https://static-cdn.jtvnw.net/jtv_user_pictures/35cc3e88-5c7c-4985-abee-36a15fc282aa-profile_image-300x300.png","video_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/79df9403-a59b-48e6-b9e3-d53a61ffe12a-channel_offline_image-1920x1080.png","profile_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/c72d1cc7-f97f-4858-b407-fe26b9ade7dc-profile_banner-480.png","profile_banner_background_color":"","url":"https://www.twitch.tv/ka1one","views":174730,"followers":2571,"broadcaster_type":"","description":"","private_video":false,"privacy_options_enabled":false}}},
        {"status":"fulfilled","value":{"_id":39641756428,"game":"FIFA 21","broadcast_platform":"live","community_id":"","community_ids":[],"viewers":16,"video_height":900,"average_fps":60,"delay":0,"created_at":"2020-10-11T11:39:16Z","is_playlist":false,"stream_type":"live","preview":{"small":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-80x45.jpg","medium":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-320x180.jpg","large":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-640x360.jpg","template":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-{width}x{height}.jpg"},"channel":{"mature":true,"status":"Cenas da Vida a um Domingo","broadcaster_language":"pt","broadcaster_software":"","display_name":"KA1ONE","game":"FIFA 21","language":"en","_id":31391096,"name":"ka1one","created_at":"2012-06-17T01:13:40.058127Z","updated_at":"2020-10-11T14:11:18.340383Z","partner":false,"logo":"https://static-cdn.jtvnw.net/jtv_user_pictures/35cc3e88-5c7c-4985-abee-36a15fc282aa-profile_image-300x300.png","video_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/79df9403-a59b-48e6-b9e3-d53a61ffe12a-channel_offline_image-1920x1080.png","profile_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/c72d1cc7-f97f-4858-b407-fe26b9ade7dc-profile_banner-480.png","profile_banner_background_color":"","url":"https://www.twitch.tv/ka1one","views":174730,"followers":2571,"broadcaster_type":"","description":"","private_video":false,"privacy_options_enabled":false}}},
        {"status":"fulfilled","value":{"_id":39641756428,"game":"FIFA 21","broadcast_platform":"live","community_id":"","community_ids":[],"viewers":16,"video_height":900,"average_fps":60,"delay":0,"created_at":"2020-10-11T11:39:16Z","is_playlist":false,"stream_type":"live","preview":{"small":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-80x45.jpg","medium":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-320x180.jpg","large":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-640x360.jpg","template":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-{width}x{height}.jpg"},"channel":{"mature":true,"status":"Cenas da Vida a um Domingo","broadcaster_language":"pt","broadcaster_software":"","display_name":"KA1ONE","game":"FIFA 21","language":"en","_id":31391096,"name":"ka1one","created_at":"2012-06-17T01:13:40.058127Z","updated_at":"2020-10-11T14:11:18.340383Z","partner":false,"logo":"https://static-cdn.jtvnw.net/jtv_user_pictures/35cc3e88-5c7c-4985-abee-36a15fc282aa-profile_image-300x300.png","video_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/79df9403-a59b-48e6-b9e3-d53a61ffe12a-channel_offline_image-1920x1080.png","profile_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/c72d1cc7-f97f-4858-b407-fe26b9ade7dc-profile_banner-480.png","profile_banner_background_color":"","url":"https://www.twitch.tv/ka1one","views":174730,"followers":2571,"broadcaster_type":"","description":"","private_video":false,"privacy_options_enabled":false}}},
        {"status":"fulfilled","value":{"_id":39641756428,"game":"FIFA 21","broadcast_platform":"live","community_id":"","community_ids":[],"viewers":16,"video_height":900,"average_fps":60,"delay":0,"created_at":"2020-10-11T11:39:16Z","is_playlist":false,"stream_type":"live","preview":{"small":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-80x45.jpg","medium":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-320x180.jpg","large":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-640x360.jpg","template":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-{width}x{height}.jpg"},"channel":{"mature":true,"status":"Cenas da Vida a um Domingo","broadcaster_language":"pt","broadcaster_software":"","display_name":"KA1ONE","game":"FIFA 21","language":"en","_id":31391096,"name":"ka1one","created_at":"2012-06-17T01:13:40.058127Z","updated_at":"2020-10-11T14:11:18.340383Z","partner":false,"logo":"https://static-cdn.jtvnw.net/jtv_user_pictures/35cc3e88-5c7c-4985-abee-36a15fc282aa-profile_image-300x300.png","video_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/79df9403-a59b-48e6-b9e3-d53a61ffe12a-channel_offline_image-1920x1080.png","profile_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/c72d1cc7-f97f-4858-b407-fe26b9ade7dc-profile_banner-480.png","profile_banner_background_color":"","url":"https://www.twitch.tv/ka1one","views":174730,"followers":2571,"broadcaster_type":"","description":"","private_video":false,"privacy_options_enabled":false}}},
        {"status":"fulfilled","value":{"_id":39641756428,"game":"FIFA 21","broadcast_platform":"live","community_id":"","community_ids":[],"viewers":16,"video_height":900,"average_fps":60,"delay":0,"created_at":"2020-10-11T11:39:16Z","is_playlist":false,"stream_type":"live","preview":{"small":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-80x45.jpg","medium":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-320x180.jpg","large":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-640x360.jpg","template":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-{width}x{height}.jpg"},"channel":{"mature":true,"status":"Cenas da Vida a um Domingo","broadcaster_language":"pt","broadcaster_software":"","display_name":"KA1ONE","game":"FIFA 21","language":"en","_id":31391096,"name":"ka1one","created_at":"2012-06-17T01:13:40.058127Z","updated_at":"2020-10-11T14:11:18.340383Z","partner":false,"logo":"https://static-cdn.jtvnw.net/jtv_user_pictures/35cc3e88-5c7c-4985-abee-36a15fc282aa-profile_image-300x300.png","video_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/79df9403-a59b-48e6-b9e3-d53a61ffe12a-channel_offline_image-1920x1080.png","profile_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/c72d1cc7-f97f-4858-b407-fe26b9ade7dc-profile_banner-480.png","profile_banner_background_color":"","url":"https://www.twitch.tv/ka1one","views":174730,"followers":2571,"broadcaster_type":"","description":"","private_video":false,"privacy_options_enabled":false}}},
        {"status":"fulfilled","value":{"_id":39641756428,"game":"FIFA 21","broadcast_platform":"live","community_id":"","community_ids":[],"viewers":16,"video_height":900,"average_fps":60,"delay":0,"created_at":"2020-10-11T11:39:16Z","is_playlist":false,"stream_type":"live","preview":{"small":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-80x45.jpg","medium":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-320x180.jpg","large":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-640x360.jpg","template":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-{width}x{height}.jpg"},"channel":{"mature":true,"status":"Cenas da Vida a um Domingo","broadcaster_language":"pt","broadcaster_software":"","display_name":"KA1ONE","game":"FIFA 21","language":"en","_id":31391096,"name":"ka1one","created_at":"2012-06-17T01:13:40.058127Z","updated_at":"2020-10-11T14:11:18.340383Z","partner":false,"logo":"https://static-cdn.jtvnw.net/jtv_user_pictures/35cc3e88-5c7c-4985-abee-36a15fc282aa-profile_image-300x300.png","video_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/79df9403-a59b-48e6-b9e3-d53a61ffe12a-channel_offline_image-1920x1080.png","profile_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/c72d1cc7-f97f-4858-b407-fe26b9ade7dc-profile_banner-480.png","profile_banner_background_color":"","url":"https://www.twitch.tv/ka1one","views":174730,"followers":2571,"broadcaster_type":"","description":"","private_video":false,"privacy_options_enabled":false}}},
        {"status":"fulfilled","value":{"_id":39641756428,"game":"FIFA 21","broadcast_platform":"live","community_id":"","community_ids":[],"viewers":16,"video_height":900,"average_fps":60,"delay":0,"created_at":"2020-10-11T11:39:16Z","is_playlist":false,"stream_type":"live","preview":{"small":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-80x45.jpg","medium":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-320x180.jpg","large":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-640x360.jpg","template":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-{width}x{height}.jpg"},"channel":{"mature":true,"status":"Cenas da Vida a um Domingo","broadcaster_language":"pt","broadcaster_software":"","display_name":"KA1ONE","game":"FIFA 21","language":"en","_id":31391096,"name":"ka1one","created_at":"2012-06-17T01:13:40.058127Z","updated_at":"2020-10-11T14:11:18.340383Z","partner":false,"logo":"https://static-cdn.jtvnw.net/jtv_user_pictures/35cc3e88-5c7c-4985-abee-36a15fc282aa-profile_image-300x300.png","video_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/79df9403-a59b-48e6-b9e3-d53a61ffe12a-channel_offline_image-1920x1080.png","profile_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/c72d1cc7-f97f-4858-b407-fe26b9ade7dc-profile_banner-480.png","profile_banner_background_color":"","url":"https://www.twitch.tv/ka1one","views":174730,"followers":2571,"broadcaster_type":"","description":"","private_video":false,"privacy_options_enabled":false}}},
        {"status":"fulfilled","value":{"_id":39641756428,"game":"FIFA 21","broadcast_platform":"live","community_id":"","community_ids":[],"viewers":16,"video_height":900,"average_fps":60,"delay":0,"created_at":"2020-10-11T11:39:16Z","is_playlist":false,"stream_type":"live","preview":{"small":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-80x45.jpg","medium":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-320x180.jpg","large":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-640x360.jpg","template":"https://static-cdn.jtvnw.net/previews-ttv/live_user_ka1one-{width}x{height}.jpg"},"channel":{"mature":true,"status":"Cenas da Vida a um Domingo","broadcaster_language":"pt","broadcaster_software":"","display_name":"KA1ONE","game":"FIFA 21","language":"en","_id":31391096,"name":"ka1one","created_at":"2012-06-17T01:13:40.058127Z","updated_at":"2020-10-11T14:11:18.340383Z","partner":false,"logo":"https://static-cdn.jtvnw.net/jtv_user_pictures/35cc3e88-5c7c-4985-abee-36a15fc282aa-profile_image-300x300.png","video_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/79df9403-a59b-48e6-b9e3-d53a61ffe12a-channel_offline_image-1920x1080.png","profile_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/c72d1cc7-f97f-4858-b407-fe26b9ade7dc-profile_banner-480.png","profile_banner_background_color":"","url":"https://www.twitch.tv/ka1one","views":174730,"followers":2571,"broadcaster_type":"","description":"","private_video":false,"privacy_options_enabled":false}}},
        {"status":"fulfilled","value":{"_id":39643037212,"game":"Alien: Isolation","broadcast_platform":"live","community_id":"","community_ids":[],"viewers":12,"video_height":720,"average_fps":60,"delay":0,"created_at":"2020-10-11T13:46:04Z","is_playlist":false,"stream_type":"live","preview":{"small":"https://static-cdn.jtvnw.net/previews-ttv/live_user_thenumber13_-80x45.jpg","medium":"https://static-cdn.jtvnw.net/previews-ttv/live_user_thenumber13_-320x180.jpg","large":"https://static-cdn.jtvnw.net/previews-ttv/live_user_thenumber13_-640x360.jpg","template":"https://static-cdn.jtvnw.net/previews-ttv/live_user_thenumber13_-{width}x{height}.jpg"},"channel":{"mature":true,"status":"6 Sábados e 1 Domingo. Borrar a cueca no espaço? Vamos. // #RazerStreamer","broadcaster_language":"pt","broadcaster_software":"","display_name":"TheNumber13_","game":"Alien: Isolation","language":"pt","_id":81028769,"name":"thenumber13_","created_at":"2015-01-27T04:37:03.297102Z","updated_at":"2020-10-11T14:14:17.516325Z","partner":false,"logo":"https://static-cdn.jtvnw.net/jtv_user_pictures/8e08f423-da21-42a6-a478-ae48e915d4a7-profile_image-300x300.png","video_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/d6ba5ef7-a14b-49f1-b2db-3ce8f21a42c4-channel_offline_image-1920x1080.jpeg","profile_banner":"https://static-cdn.jtvnw.net/jtv_user_pictures/65160fe4-1833-4eac-84ab-9351f52075cc-profile_banner-480.jpeg","profile_banner_background_color":"","url":"https://www.twitch.tv/thenumber13_","views":12564,"followers":564,"broadcaster_type":"","description":"Bom gameplay ? Vou duvidar. Javardice? Assegurada. Hotel? Trivago.","private_video":false,"privacy_options_enabled":false}}}
        ]//await Promise.allSettled(streamNamesList.map((streamer: string) => getStreamInfo(streamer)));

    results.forEach((response) => {
        if (response.status === 'fulfilled') {
            response.value && dispatch(addStream(response.value));
        }
        else console.error(response)
    });

    dispatch(sortByViewers());

    dispatch(setLoading());
};

export const {reducer: twitchReducer} = twitchSlice;